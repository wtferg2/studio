/**
 * @fileoverview Firestore Security Rules for the Dog Grooming Appointment App.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, ensuring that clients can only
 * access and modify their own data. Data is organized hierarchically under the
 * /clients/{clientId} path. All write operations are protected by authorization
 * checks, and data consistency is enforced between the path and the document's
 * internal fields to prevent unauthorized access.
 *
 * Data Structure:
 * - /clients/{clientId}: Stores client profile information.
 * - /clients/{clientId}/appointments/{appointmentId}: Stores appointment records
 *   associated with a specific client. The clientId is denormalized onto the
 *   appointment documents to enable simple, path-based access control rules.
 *
 * Key Security Decisions:
 * - Clients can only create, read, update, and delete their own appointments.
 * - Listing of all clients is not permitted.
 * - No public read access is granted to any collection.
 * - No `get()` calls are required for security rules, enhancing performance and security.
 *
 * Denormalization for Authorization:
 * The 'clientId' is stored both as the document ID in the /clients collection
 * and as a field within the appointment documents in the
 * /clients/{clientId}/appointments collection. This denormalization enables
 * direct access control based on the document path, avoiding the need for
 * additional reads to verify ownership.
 *
 * Structural Segregation:
 * All data is private and stored under the /clients/{clientId} path, ensuring
 * that only authenticated users can access their own data. There are no
 * public collections in this application.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the /clients collection, providing secure access to client data.
     * @path /clients/{clientId}
     * @allow (create) - Authenticated user can create their own client document if the clientId matches their auth UID.
     * @allow (get) - Authenticated user can read their own client document if the clientId matches their auth UID.
     * @allow (update) - Authenticated user can update their own client document if the clientId matches their auth UID.
     * @allow (delete) - Authenticated user can delete their own client document if the clientId matches their auth UID.
     * @deny (create) - An unauthenticated user attempts to create a client document.
     * @deny (get) - An unauthenticated user attempts to read a client document.
     * @deny (update) - An unauthenticated user attempts to update a client document.
     * @deny (delete) - An unauthenticated user attempts to delete a client document.
     * @principle Enforces document ownership and authenticated access.
     */
    match /clients/{clientId} {
      allow get: if isSignedIn() && isOwner(clientId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(clientId) && request.resource.data.id == clientId;
      allow update: if isSignedIn() && isOwner(clientId) && resource.data.id == request.resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(clientId);
    }

    /**
     * @description Protects the /clients/{clientId}/appointments collection, ensuring only the client can manage their appointments.
     * @path /clients/{clientId}/appointments/{appointmentId}
     * @allow (create) - Authenticated user can create an appointment under their client document.
     * @allow (get) - Authenticated user can read an appointment under their client document.
     * @allow (update) - Authenticated user can update an appointment under their client document.
     * @allow (delete) - Authenticated user can delete an appointment under their client document.
     * @deny (create) - Attempt to create an appointment under someone else's client document.
     * @deny (get) - Attempt to read an appointment under someone else's client document.
     * @deny (update) - Attempt to update an appointment under someone else's client document.
     * @deny (delete) - Attempt to delete an appointment under someone else's client document.
     * @principle Enforces document ownership and authenticated access to appointments.
     */
    match /clients/{clientId}/appointments/{appointmentId} {
      allow get: if isSignedIn() && isOwner(clientId);
      allow list: if isSignedIn() && isOwner(clientId);
      allow create: if isSignedIn() && isOwner(clientId) && request.resource.data.clientId == clientId;
      allow update: if isSignedIn() && isOwner(clientId) && resource.data.clientId == clientId;
      allow delete: if isSignedIn() && isExistingOwner(clientId);
    }

    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the resource and the resource exists.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}